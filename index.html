<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Orienteering Races Map</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- noUiSlider -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.js"></script>

  <style>
    :root { --bg:#0b0d10; --panel:#14171c; --muted:#9aa4b2; --text:#e6edf3; --accent:#4aa3ff; }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui, sans-serif; }
    .app { display:grid; grid-template-rows:auto 1fr; height:100%; }
    .controls { display:flex; gap:1rem; align-items:center; padding:.75rem 1rem; background:var(--panel); }
    .controls h1 { font-size:1rem; margin:0; font-weight:600; }
    .slider-wrap { flex:1 1 auto; min-width:260px; }
    #slider { margin:.35rem 0 .25rem; }
    .date-labels { display:flex; justify-content:space-between; font-size:.85rem; color:var(--muted); }
    .pill { background:rgba(74,163,255,.12); color:var(--accent); padding:.25rem .5rem; border-radius:999px; font-size:.8rem; white-space:nowrap; }
    .count { white-space:nowrap; }
    #map { height:calc(100vh - 64px); width:100%; }

    /* Marker style */
    .race-pin { width:14px; height:14px; border-radius:50%; background:#4aa3ff; border:2px solid #e6edf3; }

    /* Popup styling */
    .popup-wrap { min-width:260px; }
    .popup-title { font-weight:600; margin:0 0 .25rem 0; }
    .popup-sub { color:var(--muted); margin:0 0 .5rem 0; font-size:.9rem; }
    .popup-table { width:100%; border-collapse:collapse; font-size:.9rem; }
    .popup-table th, .popup-table td { text-align:left; padding:.2rem .25rem; vertical-align:top; }
    .popup-table th { color:var(--muted); font-weight:500; white-space:nowrap; }
    .popup-link { display:inline-block; margin-top:.5rem; color:var(--accent); text-decoration:underline; }
  </style>
</head>
<body>
  <div class="app">
    <div class="controls">
      <h1>Orienteering Races</h1>
      <div class="slider-wrap">
        <div id="slider"></div>
        <div class="date-labels">
          <span><strong>From</strong> <span id="startLabel">—</span></span>
          <span><strong>To</strong> <span id="endLabel">—</span></span>
        </div>
      </div>
      <div class="count"><span id="visibleCount">0</span>/<span id="totalCount">0</span></div>
    </div>
    <div id="map"></div>
  </div>

  <!--DATA:START-->
  <script>
    // Replaced by your pipeline
    window.ORIS_DATA = [{"gps":"50.080401349509,14.385781282904","date":"28.10.2025","url":"https://oris.ceskyorientak.cz/Zavod?id=9546","tbl":[{"nazev":"ORIS ID:","hodnota":"9546"},{"nazev":"Název:","hodnota":"Workshop Sport Coach+"},{"nazev":"Datum:","hodnota":"28.10.2025"},{"nazev":"Místo konání:","hodnota":"Praha - Strahov"},{"nazev":"Sport:","hodnota":"OB"},{"nazev":"Souřadnice:","hodnota":"50.080401349509,14.385781282904: Google mapy , Mapy.cz - turistická"},{"nazev":"1. termín přihlášek:","hodnota":"26.10.2025 23:59"}]},{"gps":"49.510706661738,16.958061909207","date":"28.10.2025","url":"https://oris.ceskyorientak.cz/Zavod?id=9014","tbl":[{"nazev":"ORIS ID:","hodnota":"9014"},{"nazev":"Název:","hodnota":"Oblastní žebříček"},{"nazev":"Datum:","hodnota":"28.10.2025"},{"nazev":"Místo konání:","hodnota":"Ptení"},{"nazev":"Start 00:","hodnota":"11:00"},{"nazev":"Sport:","hodnota":"OB"},{"nazev":"Souřadnice:","hodnota":"49.510706661738,16.958061909207: Google mapy , Mapy.cz - turistická"},{"nazev":"Datum spuštění přihlášek:","hodnota":"29.09.2025 15:20"},{"nazev":"1. termín přihlášek:","hodnota":"22.10.2025 23:59"},{"nazev":"2. termín přihlášek:","hodnota":"24.10.2025 23:59 Navýšení vkladu: 50 %r"},{"nazev":"Datum splatnosti:","hodnota":"27.09.2025"}]},{"gps":"49.577812195482,16.050537228584","date":"01.11.2025","url":"https://oris.ceskyorientak.cz/Zavod?id=9046","tbl":[{"nazev":"ORIS ID:","hodnota":"9046"},{"nazev":"Název:","hodnota":"Mistrovství oblasti v nočním OB"},{"nazev":"Datum:","hodnota":"01.11.2025"},{"nazev":"Místo konání:","hodnota":"Vysočina aréna Nové Město na Moravě"},{"nazev":"Sport:","hodnota":"OB"},{"nazev":"Souřadnice:","hodnota":"49.577812195482,16.050537228584: Google mapy , Mapy.cz - turistická"},{"nazev":"1. termín přihlášek:","hodnota":"26.10.2025 23:59"},{"nazev":"2. termín přihlášek:","hodnota":"28.10.2025 23:59 Navýšení vkladu: 50 %r"},{"nazev":"Datum splatnosti:","hodnota":"30.10.2025"}]},{"gps":"49.845448098968,18.153330087662","date":"01.11.2025","url":"https://oris.ceskyorientak.cz/Zavod?id=9061","tbl":[{"nazev":"ORIS ID:","hodnota":"9061"},{"nazev":"Název:","hodnota":"Oblastní žebříček"},{"nazev":"Datum:","hodnota":"01.11.2025"},{"nazev":"Místo konání:","hodnota":""},{"nazev":"Sport:","hodnota":"OB"},{"nazev":"Souřadnice:","hodnota":"49.845448098968,18.153330087662: Google mapy , Mapy.cz - turistická"},{"nazev":"Datum spuštění přihlášek:","hodnota":"03.10.2025 22:54"},{"nazev":"1. termín přihlášek:","hodnota":"26.10.2025 22:59"},{"nazev":"2. termín přihlášek:","hodnota":"29.10.2025 14:41"}]},{"gps":"49.208415840928,17.44904623181","date":"01.11.2025","url":"https://oris.ceskyorientak.cz/Zavod?id=8995","tbl":[{"nazev":"ORIS ID:","hodnota":"8995"},{"nazev":"Název:","hodnota":"Oblastní žebříček"},{"nazev":"Datum:","hodnota":"01.11.2025"},{"nazev":"Místo konání:","hodnota":"Nová Dědina"},{"nazev":"Start 00:","hodnota":"10:00"},{"nazev":"Sport:","hodnota":"OB"},{"nazev":"Souřadnice:","hodnota":"49.208415840928,17.44904623181: Google mapy , Mapy.cz - turistická"},{"nazev":"1. termín přihlášek:","hodnota":"26.10.2025 23:59"},{"nazev":"2. termín přihlášek:","hodnota":"27.10.2025 16:00 Navýšení vkladu: 50 %r"}]},{"gps":"50.395647441775,15.616271495819","date":"01.11.2025","url":"https://oris.ceskyorientak.cz/Zavod?id=8838","tbl":[{"nazev":"ORIS ID:","hodnota":"8838"},{"nazev":"Název:","hodnota":"Oblastní žebříček"},{"nazev":"Datum:","hodnota":"01.11.2025"},{"nazev":"Místo konání:","hodnota":"Lukavec u Hořic"},{"nazev":"Start 00:","hodnota":"10:00"},{"nazev":"Sport:","hodnota":"OB"},{"nazev":"Souřadnice:","hodnota":"50.395647441775,15.616271495819: Google mapy , Mapy.cz - turistická"},{"nazev":"1. termín přihlášek:","hodnota":"26.10.2025 23:59"},{"nazev":"Datum splatnosti:","hodnota":"29.10.2025"}]},{"gps":"49.945762495281,14.804530441761","date":"01.11.2025","url":"https://oris.ceskyorientak.cz/Zavod?id=9140","tbl":[{"nazev":"ORIS ID:","hodnota":"9140"},{"nazev":"Název:","hodnota":"Oblastní žebříček"},{"nazev":"Datum:","hodnota":"01.11.2025"},{"nazev":"Místo konání:","hodnota":"Černé Voděrady, louka u Voděradského rybníka"},{"nazev":"Start 00:","hodnota":"10:30"},{"nazev":"Sport:","hodnota":"OB"},{"nazev":"Souřadnice:","hodnota":"49.945762495281,14.804530441761: Google mapy , Mapy.cz - turistická"},{"nazev":"1. termín přihlášek:","hodnota":"26.10.2025 23:59"},{"nazev":"2. termín přihlášek:","hodnota":"28.10.2025 23:59"},{"nazev":"Datum splatnosti:","hodnota":"30.10.2025"}]},{"gps":"49.65685,17.01112","date":"01.11.2025","url":"https://oris.ceskyorientak.cz/Zavod?id=9015","tbl":[{"nazev":"ORIS ID:","hodnota":"9015"},{"nazev":"Název:","hodnota":"Oblastní žebříček"},{"nazev":"Datum:","hodnota":"01.11.2025"},{"nazev":"Místo konání:","hodnota":"Loučka u Litovle"},{"nazev":"Start 00:","hodnota":"11:00"},{"nazev":"Sport:","hodnota":"OB"},{"nazev":"Souřadnice:","hodnota":"49.65685,17.01112: Google mapy , Mapy.cz - turistická"},{"nazev":"Datum spuštění přihlášek:","hodnota":"23.09.2025 16:06"},{"nazev":"1. termín přihlášek:","hodnota":"27.10.2025 23:59"},{"nazev":"2. termín přihlášek:","hodnota":"29.10.2025 23:59 Navýšení vkladu: 50 %r"},{"nazev":"3. termín přihlášek:","hodnota":"30.10.2025 00:00 Navýšení vkladu: 100 %r"}]},{"gps":"49.577676538948,16.050510406494","date":"01.11.2025","url":"https://oris.ceskyorientak.cz/Zavod?id=9045","tbl":[{"nazev":"ORIS ID:","hodnota":"9045"},{"nazev":"Název:","hodnota":"Oblastní žebříček"},{"nazev":"Datum:","hodnota":"01.11.2025"},{"nazev":"Místo konání:","hodnota":"Vysočina aréna Nové Město na Moravě"},{"nazev":"Start 00:","hodnota":"12:00"},{"nazev":"Sport:","hodnota":"OB"},{"nazev":"Souřadnice:","hodnota":"49.577676538948,16.050510406494: Google mapy , Mapy.cz - turistická"},{"nazev":"1. termín přihlášek:","hodnota":"26.10.2025 23:59"},{"nazev":"2. termín přihlášek:","hodnota":"28.10.2025 23:59"}]},{"gps":"","date":"02.11.2025","url":"https://oris.ceskyorientak.cz/Zavod?id=9493","tbl":[{"nazev":"ORIS ID:","hodnota":"9493"},{"nazev":"Název:","hodnota":"Srovnávací testy mládeže MTBO 2. termín"},{"nazev":"Datum:","hodnota":"02.11.2025"},{"nazev":"Místo konání:","hodnota":"Kladno"},{"nazev":"Sport:","hodnota":"MTBO"},{"nazev":"1. termín přihlášek:","hodnota":"24.10.2025 23:59"},{"nazev":"2. termín přihlášek:","hodnota":"26.10.2025 23:59"}]},{"gps":"50.777096941806,15.097682476044","date":"02.11.2025","url":"https://oris.ceskyorientak.cz/Zavod?id=9101","tbl":[{"nazev":"ORIS ID:","hodnota":"9101"},{"nazev":"Název:","hodnota":"Oblastní žebříček"},{"nazev":"Datum:","hodnota":"02.11.2025"},{"nazev":"Místo konání:","hodnota":"Střelnice Starý Harcov, Liberec"},{"nazev":"Start 00:","hodnota":"10:00"},{"nazev":"Sport:","hodnota":"OB"},{"nazev":"Souřadnice:","hodnota":"50.777096941806,15.097682476044: Google mapy , Mapy.cz - turistická"},{"nazev":"1. termín přihlášek:","hodnota":"26.10.2025 23:59"},{"nazev":"2. termín přihlášek:","hodnota":"29.10.2025 23:59 Navýšení vkladu: 50 %r"}]},{"gps":"49.823220745227,16.104900103072","date":"07.11.2025","url":"https://oris.ceskyorientak.cz/Zavod?id=9478","tbl":[{"nazev":"ORIS ID:","hodnota":"9478"},{"nazev":"Název:","hodnota":"Školení začínajících kartografů"},{"nazev":"Datum:","hodnota":"07.11.2025"},{"nazev":"Místo konání:","hodnota":"Zderaz"},{"nazev":"Start 00:","hodnota":"11:00"},{"nazev":"Sport:","hodnota":"OB"},{"nazev":"Souřadnice:","hodnota":"49.823220745227,16.104900103072: Google mapy , Mapy.cz - turistická"},{"nazev":"Datum spuštění přihlášek:","hodnota":"10.08.2025 15:02"},{"nazev":"1. termín přihlášek:","hodnota":"30.09.2025 23:59"}]},{"gps":"50.051683040569,16.071152687073","date":"08.11.2025","url":"https://oris.ceskyorientak.cz/Zavod?id=8839","tbl":[{"nazev":"ORIS ID:","hodnota":"8839"},{"nazev":"Název:","hodnota":"Oblastní žebříček"},{"nazev":"Datum:","hodnota":"08.11.2025"},{"nazev":"Místo konání:","hodnota":"Horní Jelení, RS Tramtáryje"},{"nazev":"Start 00:","hodnota":"10:00"},{"nazev":"Sport:","hodnota":"OB"},{"nazev":"Souřadnice:","hodnota":"50.051683040569,16.071152687073: Google mapy , Mapy.cz - turistická"},{"nazev":"1. termín přihlášek:","hodnota":"02.11.2025 23:59"},{"nazev":"Datum splatnosti:","hodnota":"05.11.2025"}]},{"gps":"50.097128550179,14.333446025848","date":"08.11.2025","url":"https://oris.ceskyorientak.cz/Zavod?id=9141","tbl":[{"nazev":"ORIS ID:","hodnota":"9141"},{"nazev":"Název:","hodnota":"Oblastní žebříček"},{"nazev":"Datum:","hodnota":"08.11.2025"},{"nazev":"Místo konání:","hodnota":"Praha-Vokovice, zábavní park DinoLive"},{"nazev":"Start 00:","hodnota":"11:00"},{"nazev":"Sport:","hodnota":"OB"},{"nazev":"Souřadnice:","hodnota":"50.097128550179,14.333446025848: Google mapy , Mapy.cz - turistická"},{"nazev":"1. termín přihlášek:","hodnota":"03.11.2025 23:59"},{"nazev":"2. termín přihlášek:","hodnota":"05.11.2025 23:59"}]},{"gps":"50.203752569439,15.829233509617","date":"22.11.2025","url":"https://oris.ceskyorientak.cz/Zavod?id=9503","tbl":[{"nazev":"ORIS ID:","hodnota":"9503"},{"nazev":"Název:","hodnota":"Metodický seminář trenérů a rozhodčích"},{"nazev":"Datum:","hodnota":"22.11.2025"},{"nazev":"Místo konání:","hodnota":"Hradec Králové - univerzitní kampus"},{"nazev":"Start 00:","hodnota":"09:00"},{"nazev":"Sport:","hodnota":"OB"},{"nazev":"Souřadnice:","hodnota":"50.203752569439,15.829233509617: Google mapy , Mapy.cz - turistická"},{"nazev":"1. termín přihlášek:","hodnota":"09.11.2025 23:59"}]},{"gps":"49.219503230226,16.689873933792","date":"29.11.2025","url":"https://oris.ceskyorientak.cz/Zavod?id=9593","tbl":[{"nazev":"ORIS ID:","hodnota":"9593"},{"nazev":"Název:","hodnota":"TRAIL-O Brno – sobotní PreO"},{"nazev":"Datum:","hodnota":"29.11.2025"},{"nazev":"Místo konání:","hodnota":"Brno, Velká Klajdovka"},{"nazev":"Sport:","hodnota":"TRAIL"},{"nazev":"Souřadnice:","hodnota":"49.219503230226,16.689873933792: Google mapy , Mapy.cz - turistická"}]},{"gps":"49.22417012311,16.755169630051","date":"30.11.2025","url":"https://oris.ceskyorientak.cz/Zavod?id=9594","tbl":[{"nazev":"ORIS ID:","hodnota":"9594"},{"nazev":"Název:","hodnota":"TRAIL-O Brno – nedělní PreO"},{"nazev":"Datum:","hodnota":"30.11.2025"},{"nazev":"Místo konání:","hodnota":"Mokrá"},{"nazev":"Sport:","hodnota":"TRAIL"},{"nazev":"Souřadnice:","hodnota":"49.22417012311,16.755169630051: Google mapy , Mapy.cz - turistická"}]},{"gps":"49.224191144153,16.755191087723","date":"30.11.2025","url":"https://oris.ceskyorientak.cz/Zavod?id=9595","tbl":[{"nazev":"ORIS ID:","hodnota":"9595"},{"nazev":"Název:","hodnota":"TRAIL-O Brno – nedělní TempO"},{"nazev":"Datum:","hodnota":"30.11.2025"},{"nazev":"Místo konání:","hodnota":"Mokrá"},{"nazev":"Sport:","hodnota":"TRAIL"},{"nazev":"Souřadnice:","hodnota":"49.224191144153,16.755191087723: Google mapy , Mapy.cz - turistická"}]},{"gps":"50.032017959718,15.41620016098","date":"05.12.2025","url":"https://oris.ceskyorientak.cz/Zavod?id=9453","tbl":[{"nazev":"ORIS ID:","hodnota":"9453"},{"nazev":"Název:","hodnota":"Metodický seminář: sprintové mapy"},{"nazev":"Datum:","hodnota":"05.12.2025"},{"nazev":"Místo konání:","hodnota":"Chvaletice"},{"nazev":"Sport:","hodnota":"OB"},{"nazev":"Souřadnice:","hodnota":"50.032017959718,15.41620016098: Google mapy , Mapy.cz - turistická"},{"nazev":"1. termín přihlášek:","hodnota":"23.11.2025 23:59"},{"nazev":"Datum splatnosti:","hodnota":"03.12.2025"}]},{"gps":"50.080496015731,14.385480880737","date":"14.12.2025","url":"https://oris.ceskyorientak.cz/Zavod?id=9561","tbl":[{"nazev":"ORIS ID:","hodnota":"9561"},{"nazev":"Název:","hodnota":"Workshop nástrojů pro stavbu tratí pro tréninky i závody (OCAD / Purple Pen + OOMapper)"},{"nazev":"Datum:","hodnota":"14.12.2025"},{"nazev":"Místo konání:","hodnota":"Praha, Zátopkova 100/2"},{"nazev":"Start 00:","hodnota":"09:00"},{"nazev":"Sport:","hodnota":"OB"},{"nazev":"Souřadnice:","hodnota":"50.080496015731,14.385480880737: Google mapy , Mapy.cz - turistická"},{"nazev":"1. termín přihlášek:","hodnota":"07.12.2025 23:59"},{"nazev":"Datum splatnosti:","hodnota":"10.12.2025"}]},{"gps":"50.55344,15.54936","date":"10.01.2026","url":"https://oris.ceskyorientak.cz/Zavod?id=9547","tbl":[{"nazev":"ORIS ID:","hodnota":"9547"},{"nazev":"Název:","hodnota":"Český pohár, ŽA, ŽB - sprint"},{"nazev":"Datum:","hodnota":"10.01.2026"},{"nazev":"Místo konání:","hodnota":"Studenec"},{"nazev":"Sport:","hodnota":"LOB"},{"nazev":"Souřadnice:","hodnota":"50.55344,15.54936: Google mapy , Mapy.cz - turistická"}]},{"gps":"50.55344,15.54936","date":"11.01.2026","url":"https://oris.ceskyorientak.cz/Zavod?id=9548","tbl":[{"nazev":"ORIS ID:","hodnota":"9548"},{"nazev":"Název:","hodnota":"Český pohár, ŽA, ŽB - krátká trať"},{"nazev":"Datum:","hodnota":"11.01.2026"},{"nazev":"Místo konání:","hodnota":"Studenec"},{"nazev":"Sport:","hodnota":"LOB"},{"nazev":"Souřadnice:","hodnota":"50.55344,15.54936: Google mapy , Mapy.cz - turistická"}]},{"gps":"47.70092,14.42255","date":"17.01.2026","url":"https://oris.ceskyorientak.cz/Zavod?id=9549","tbl":[{"nazev":"ORIS ID:","hodnota":"9549"},{"nazev":"Název:","hodnota":"Český pohár, ŽA, ŽB - krátká trať"},{"nazev":"Datum:","hodnota":"17.01.2026"},{"nazev":"Místo konání:","hodnota":"Rosenau"},{"nazev":"Sport:","hodnota":"LOB"},{"nazev":"Souřadnice:","hodnota":"47.70092,14.42255: Google mapy , Mapy.cz - turistická"}]},{"gps":"47.70092,14.42255","date":"18.01.2026","url":"https://oris.ceskyorientak.cz/Zavod?id=9550","tbl":[{"nazev":"ORIS ID:","hodnota":"9550"},{"nazev":"Název:","hodnota":"Český pohár, ŽA, ŽB - krátká trať"},{"nazev":"Datum:","hodnota":"18.01.2026"},{"nazev":"Místo konání:","hodnota":"Rosenau"},{"nazev":"Sport:","hodnota":"LOB"},{"nazev":"Souřadnice:","hodnota":"47.70092,14.42255: Google mapy , Mapy.cz - turistická"}]},{"gps":"","date":"24.01.2026","url":"https://oris.ceskyorientak.cz/Zavod?id=9562","tbl":[{"nazev":"ORIS ID:","hodnota":"9562"},{"nazev":"Název:","hodnota":"Workshop pro organizátory závodů"},{"nazev":"Datum:","hodnota":"24.01.2026"},{"nazev":"Místo konání:","hodnota":"Praha - Strahov"},{"nazev":"Sport:","hodnota":"OB"}]}];
  </script>
  <!--DATA:END-->

<script>
  // ---------- Helpers ----------
  const MS_PER_DAY = 86400000;

  // Fields to hide in the popup table
  const HIDE_FIELDS = new Set(['ORIS ID', 'Souřadnice']);

  // Parse "04.10.2025" or "2025-10-04" -> Date (local midnight)
  function parseDMY(s){
    if (!s) return null;
    const iso = /^\d{4}-\d{2}-\d{2}$/;
    if (iso.test(s)) return new Date(s + "T00:00:00");
    const m = s.match(/^(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{2,4})$/);
    if (!m) return null;
    const d = +m[1], mo = +m[2] - 1, y = m[3].length === 2 ? 2000 + +m[3] : +m[3];
    return new Date(y, mo, d);
  }
  const fmtDate = (d) => d ? d.toLocaleDateString(undefined, {year:'numeric', month:'2-digit', day:'2-digit'}) : "";

  // Use a timezone-agnostic day number for comparisons (UTC day index)
  const toDayNumUTC = (d) => d ? Math.floor(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()) / MS_PER_DAY) : NaN;
  // Convert day number back to a *local* Date for labels
  const dayNumToLocalDate = (n) => {
    const du = new Date(n * MS_PER_DAY);
    return new Date(du.getUTCFullYear(), du.getUTCMonth(), du.getUTCDate());
  };

  // Optional status reporter; not tied to any DOM node
  const setStatus = (msg) => { /* no-op; swap to console.info(msg) if desired */ };

  function dotIcon(){ return L.divIcon({ className:'race-pin', iconSize:[14,14] }); }

  // ---------- Map ----------
  const map = L.map('map', { worldCopyJump: true });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
  map.setView([20, 0], 2);

  const layerGroup = L.layerGroup().addTo(map);

  // ---------- Data ingest ----------
  let allRecords = [];
  let didAutoFitOnce = false; // only auto-fit on the very first render

  function getField(tbl, label){
    if (!Array.isArray(tbl)) return '';
    const found = tbl.find(x => (x?.nazev || '').replace(/:$/,'') === label.replace(/:$/,''));
    return found ? (found.hodnota || '') : '';
  }

  function buildPopupHTML(r){
    const safe = (x) => String(x ?? '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const rows = (r.rawTable || [])
      .filter(({ nazev }) => !HIDE_FIELDS.has(String(nazev || '').replace(/:$/,'')))
      .map(({ nazev, hodnota }) =>
        `<tr><th>${safe((nazev||'').replace(/:$/,''))}</th><td>${safe(hodnota||'')}</td></tr>`
      ).join('');
    const title = safe(r.name || '(bez názvu)');
    const place = safe(r.place || '');
    const date = r.date ? fmtDate(r.date) : '';
    const link = r.link ? `<a class="popup-link" href="${r.link}" target="_blank" rel="noopener">Otevřít v ORIS</a>` : '';
    return `
      <div class="popup-wrap">
        <div class="popup-title">${title}</div>
        <div class="popup-sub">${[place, date].filter(Boolean).join(' • ')}</div>
        <table class="popup-table">${rows}</table>
        ${link}
      </div>`;
  }

  function makeMarker(r){
    const m = L.marker([r.lat, r.lon], { icon: dotIcon() });
    m.bindPopup(buildPopupHTML(r), { direction: "center" });
    return m;
  }

  // Build records from ORIS_DATA
  (function(){
    try {
      const rows = Array.isArray(window.ORIS_DATA) ? window.ORIS_DATA : [];
      const recs = [];

      for (const row of rows){
        // Coordinates from 'gps' or from 'Souřadnice'
        let lat = NaN, lon = NaN;
        const gpsRaw = row.gps || getField(row.tbl, 'Souřadnice');
        if (gpsRaw){
          const m = String(gpsRaw).match(/(-?\d+(?:\.\d+)?)[,\s]+(-?\d+(?:\.\d+)?)/);
          if (m){ lat = parseFloat(m[1]); lon = parseFloat(m[2]); }
        }
        if (isNaN(lat) || isNaN(lon)) continue;

        const name   = getField(row.tbl, 'Název');
        const place  = getField(row.tbl, 'Místo konání');
        const date   = parseDMY(getField(row.tbl, 'Datum'));
        const orisId = getField(row.tbl, 'ORIS ID');
        const link   = orisId ? `https://oris.orientacnisporty.cz/Zavod?id=${encodeURIComponent(orisId)}` : (row.url || '');

        const record = {
          name, place, date, link,
          dateNum: toDayNumUTC(date),
          lat, lon,
          rawTable: row.tbl
        };
        record.marker = makeMarker(record);
        recs.push(record);
      }

      // Sort by date (unknown last)
      recs.sort((a,b)=>{
        if (!a.date && !b.date) return 0;
        if (!a.date) return 1;
        if (!b.date) return -1;
        return a.date - b.date;
      });

      allRecords = recs;
      const totalEl = document.getElementById('totalCount');
      if (totalEl) totalEl.textContent = allRecords.length;

      if (!allRecords.length){
        setStatus('No valid records.');
        console.warn('No valid records to display.');
        // Still initialize slider so labels don’t remain blank
        initSliderAndRender();
        return;
      }

      initSliderAndRender();
    } catch (e){
      console.error(e);
      setStatus('Error');
    }
  })();

  // ---------- Slider + filtering (ALL races) ----------
  function initSliderAndRender(){
    const dated = allRecords.filter(r => Number.isFinite(r.dateNum));
    const todayNum = toDayNumUTC(new Date());
    const minNum = dated.length ? Math.min(...dated.map(r => r.dateNum)) : todayNum;
    const maxNum = dated.length ? Math.max(...dated.map(r => r.dateNum)) : minNum;

    const slider = document.getElementById('slider');
    if (!slider){
      console.error('#slider element is missing.');
      return;
    }

    // Create only once (in case this function ever gets reused)
    if (!slider.noUiSlider){
      noUiSlider.create(slider, {
        start: [minNum, maxNum],
        connect: true,
        step: 1,
        range: { min: minNum, max: maxNum },
        behaviour: 'tap-drag'
      });
    } else {
      slider.noUiSlider.updateOptions({ range: { min: minNum, max: maxNum } }, false);
      slider.noUiSlider.set([minNum, maxNum]);
    }

    const st = document.getElementById('startLabel');
    const en = document.getElementById('endLabel');
    const visibleCountEl = document.getElementById('visibleCount');

    const paint = () => {
      const vals = slider.noUiSlider.get();
      const a0 = Math.round(+vals[0]);
      const b0 = Math.round(+vals[1]);
      const a = Math.min(a0, b0), b = Math.max(a0, b0);

      if (st) st.textContent = fmtDate(dayNumToLocalDate(a));
      if (en) en.textContent = fmtDate(dayNumToLocalDate(b));

      layerGroup.clearLayers();
      let shown = 0;
      const bounds = L.latLngBounds();

      for (const r of allRecords){
        if (Number.isFinite(r.dateNum) && r.dateNum >= a && r.dateNum <= b){
          r.marker.addTo(layerGroup);
          bounds.extend([r.lat, r.lon]);
          shown++;
        }
      }

      if (visibleCountEl) visibleCountEl.textContent = shown;

      // Auto-fit only once (on very first render), then never again
      if (!didAutoFitOnce && shown > 0 && bounds.isValid()){
        map.fitBounds(bounds.pad(0.15));
        didAutoFitOnce = true;
      }

      // Optional: announce to console (no DOM dependency)
      setStatus(`Showing ${shown} events in range ${fmtDate(dayNumToLocalDate(a))} – ${fmtDate(dayNumToLocalDate(b))}`);
    };

    slider.noUiSlider.off('update'); // ensure we don’t double-bind
    slider.noUiSlider.on('update', paint);
    paint(); // initial paint
  }
</script>

</body>
</html>
