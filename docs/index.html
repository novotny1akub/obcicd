<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Orienteering Races Map</title>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- noUiSlider -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.js"></script>

  <style>
    :root {
      --bg: #0b0d10; --panel: #14171c; --muted: #9aa4b2; --text: #e6edf3; --accent: #4aa3ff;
    }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, sans-serif; }
    .app { display: grid; grid-template-rows: auto 1fr; height: 100%; }
    .controls { display:flex; gap: 1rem; align-items:center; padding: .75rem 1rem; background: var(--panel); }
    .controls h1 { font-size: 1rem; margin: 0; font-weight: 600; }
    .slider-wrap { flex: 1 1 auto; }
    #slider { margin: .25rem 0; }
    .date-labels { display:flex; justify-content: space-between; font-size:.85rem; color: var(--muted); }
    .pill { background: rgba(74,163,255,.12); color: var(--accent); padding: .25rem .5rem; border-radius: 999px; font-size: .8rem; }
    .count { white-space: nowrap; }
    #map { height: calc(100vh - 64px); width: 100%; }
    .race-pin { width: 14px; height: 14px; border-radius: 50%; background: #4aa3ff; border: 2px solid #e6edf3; }
  </style>
</head>
<body>
  <div class="app">
    <div class="controls">
      <h1>Orienteering Races</h1>
      <span class="pill" id="status">Loading…</span>
      <div class="slider-wrap">
        <div id="slider"></div>
        <div class="date-labels">
          <span id="startLabel">—</span><span id="endLabel">—</span>
        </div>
      </div>
      <div class="count"><span id="visibleCount">0</span>/<span id="totalCount">0</span></div>
    </div>
    <div id="map"></div>
  </div>

<!--DATA:START-->
<script>
  window.ORIS_DATA = [
{"date":"27.09.2025","name":"Oblastní žebříček","place":"Kunčice pod Ondřejníkem","link":"https://oris.orientacnisporty.cz/Zavod?id=9057","lat":49.5373,"lon":18.2834},
{"date":"27.09.2025","name":"Oblastní žebříček","place":"Tužín","link":"https://oris.orientacnisporty.cz/Zavod?id=8833","lat":50.4669,"lon":15.4376},
{"date":"27.09.2025","name":"Oblastní žebříček","place":"louka u obce Krásná Studánka, GPS: 50.8140569N, 15.0202117E","link":"https://oris.orientacnisporty.cz/Zavod?id=9097","lat":50.814,"lon":15.0205},
{"date":"27.09.2025","name":"Oblastní žebříček","place":"Ochoz u Brna","link":"https://oris.orientacnisporty.cz/Zavod?id=8992","lat":49.2506,"lon":16.7619},
{"date":"27.09.2025","name":"Oblastní žebříček","place":"Plešice","link":"https://oris.orientacnisporty.cz/Zavod?id=9043","lat":49.1655,"lon":16.0391},
{"date":"27.09.2025","name":"Oblastní žebříček","place":"Poteplí","link":"https://oris.orientacnisporty.cz/Zavod?id=9135","lat":50.0671,"lon":14.0751},
{"date":"27.09.2025","name":"Oblastní žebříček","place":"Stražisko, Růžov","link":"https://oris.orientacnisporty.cz/Zavod?id=9010","lat":49.5446,"lon":16.9387},
{"date":"27.09.2025","name":"Oblastní žebříček","place":"Kemp U HROCHA - Chrášťovice","link":"https://oris.orientacnisporty.cz/Zavod?id=9155","lat":50.0094,"lon":13.3693},
{"date":"27.09.2025","name":"Oblastní žebříček","place":"Chroboly","link":"https://oris.orientacnisporty.cz/Zavod?id=9117","lat":48.9551,"lon":14.0569},
{"date":"27.09.2025","name":"Český pohár 18. kolo","place":"Tužín","link":"https://oris.orientacnisporty.cz/Zavod?id=9197","lat":50.4665,"lon":15.4381},
{"date":"28.09.2025","name":"Oblastní žebříček","place":"Rtyně v Podkrkonoší, skautské centrum","link":"https://oris.orientacnisporty.cz/Zavod?id=8834","lat":50.5007,"lon":16.0658},
{"date":"28.09.2025","name":"Oblastní žebříček","place":"Kemp U HROCHA - Chrášťovice","link":"https://oris.orientacnisporty.cz/Zavod?id=9156","lat":50.0097,"lon":13.3695},
{"date":"28.09.2025","name":"Mistrovství ČR (DRUŽSTVA)","place":"Tužín","link":"https://oris.orientacnisporty.cz/Zavod?id=9199","lat":50.4668,"lon":15.4377},
{"date":"28.09.2025","name":"Oblastní žebříček","place":"Prachatice","link":"https://oris.orientacnisporty.cz/Zavod?id=9118","lat":49.0084,"lon":13.9937},
{"date":"28.09.2025","name":"Oblastní žebříček","place":"Mokrsko","link":"https://oris.orientacnisporty.cz/Zavod?id=9136","lat":49.746,"lon":14.3393},
{"date":"04.10.2025","name":"Grant Thornton Mistrovství a Veteraniáda ČR štafet","place":"Výšice","link":"https://oris.orientacnisporty.cz/Zavod?id=8509","lat":49.4521,"lon":14.0047},
{"date":"05.10.2025","name":"Grant Thornton Mistrovství a Veteraniáda ČR klubů, Mistrovství ČR oblastních výběrů žactva","place":"Výšice","link":"https://oris.orientacnisporty.cz/Zavod?id=8510","lat":49.4523,"lon":14.0046},
{"date":"11.10.2025","name":"Oblastní žebříček","place":"Bolatice, rekreační areál SHD Borová","link":"https://oris.orientacnisporty.cz/Zavod?id=9058","lat":49.9605,"lon":18.108},
{"date":"11.10.2025","name":"Oblastní žebříček","place":"Orlovská myslivna u obce Kejžlice","link":"https://oris.orientacnisporty.cz/Zavod?id=9044","lat":49.5814,"lon":15.4104},
{"date":"11.10.2025","name":"Oblastní žebříček","place":"Dvořisko, louka u rybníka Orličan","link":"https://oris.orientacnisporty.cz/Zavod?id=8835","lat":49.9804,"lon":16.1957},
{"date":"11.10.2025","name":"Oblastní žebříček","place":"Vacenovice","link":"https://oris.orientacnisporty.cz/Zavod?id=8993","lat":48.938,"lon":17.1809},
{"date":"11.10.2025","name":"Oblastní žebříček","place":"Ražení:","link":"https://oris.orientacnisporty.cz/Zavod?id=9011","lat":49.9568,"lon":17.2378},
{"date":"11.10.2025","name":"Oblastní žebříček","place":"Letiště u obce Bynovec","link":"https://oris.orientacnisporty.cz/Zavod?id=9098","lat":50.8215,"lon":14.2696},
{"date":"11.10.2025","name":"Oblastní žebříček","place":"Dobřív","link":"https://oris.orientacnisporty.cz/Zavod?id=9157","lat":49.7211,"lon":13.7014},
{"date":"11.10.2025","name":"Oblastní žebříček","place":"Dub u Prachatic","link":"https://oris.orientacnisporty.cz/Zavod?id=9119","lat":49.1051,"lon":14.0159},
{"date":"12.10.2025","name":"Oblastní žebříček","place":"Dub u Prachatic","link":"https://oris.orientacnisporty.cz/Zavod?id=9120","lat":49.105,"lon":14.0159},
{"date":"12.10.2025","name":"Oblastní žebříček","place":"Dobřív","link":"https://oris.orientacnisporty.cz/Zavod?id=9137","lat":49.721,"lon":13.7013},
{"date":"12.10.2025","name":"Oblastní žebříček","place":"Letiště u obce Bynovec","link":"https://oris.orientacnisporty.cz/Zavod?id=9099","lat":50.8213,"lon":14.2678},
{"date":"18.10.2025","name":"Oblastní žebříček","place":"Vimperk","link":"https://oris.orientacnisporty.cz/Zavod?id=9121","lat":49.0584,"lon":13.7797},
{"date":"18.10.2025","name":"Oblastní žebříček","place":"Slopné","link":"https://oris.orientacnisporty.cz/Zavod?id=8994","lat":49.1664,"lon":17.8413},
{"date":"18.10.2025","name":"Oblastní žebříček","place":"Špindlerův Mlýn, skiáreál Svatý Petr","link":"https://oris.orientacnisporty.cz/Zavod?id=8836","lat":50.7201,"lon":15.6143},
{"date":"18.10.2025","name":"Oblastní žebříček","place":"Fryšava pod Žákovou horou, hřiště u Obecního rybníku","link":"https://oris.orientacnisporty.cz/Zavod?id=8976","lat":49.6462,"lon":16.0403},
{"date":"18.10.2025","name":"Oblastní žebříček","place":"Alšovice, sokolovna","link":"https://oris.orientacnisporty.cz/Zavod?id=9100","lat":50.678,"lon":15.231},
{"date":"18.10.2025","name":"Oblastní žebříček","place":"Kamenice, osada Těptín","link":"https://oris.orientacnisporty.cz/Zavod?id=9138","lat":49.889,"lon":14.5656},
{"date":"18.10.2025","name":"Oblastní žebříček","place":"Čechy pod Kosířem","link":"https://oris.orientacnisporty.cz/Zavod?id=9012","lat":49.5502,"lon":17.0341},
{"date":"18.10.2025","name":"Oblastní žebříček","place":"Hotel Berghof","link":"https://oris.orientacnisporty.cz/Zavod?id=9158","lat":50.3694,"lon":12.8959},
{"date":"19.10.2025","name":"Oblastní žebříček","place":"Ražení:","link":"https://oris.orientacnisporty.cz/Zavod?id=9139","lat":49.8323,"lon":13.802},
{"date":"19.10.2025","name":"Oblastní žebříček","place":"Hotel Berghof","link":"https://oris.orientacnisporty.cz/Zavod?id=9159","lat":50.3696,"lon":12.8955},
{"date":"19.10.2025","name":"Oblastní žebříček","place":"obec Sázava, koupaliště","link":"https://oris.orientacnisporty.cz/Zavod?id=8982","lat":49.5551,"lon":15.8763},
{"date":"19.10.2025","name":"Oblastní žebříček","place":"Václavovice – fotbalové hřiště","link":"https://oris.orientacnisporty.cz/Zavod?id=9059","lat":49.7526,"lon":18.3734},
{"date":"25.10.2025","name":"GAPP Czech O-Tour 2025 - Krušné hory","place":"Lesná, Krušné hory","link":"https://oris.orientacnisporty.cz/Zavod?id=8888","lat":50.5647,"lon":13.431},
{"date":"25.10.2025","name":"Oblastní žebříček","place":"Třinec- Kanada","link":"https://oris.orientacnisporty.cz/Zavod?id=9060","lat":49.6769,"lon":18.6455},
{"date":"25.10.2025","name":"YO!Camp 2025","place":"Ostružná, penzion Na mlýně","link":"https://oris.orientacnisporty.cz/Zavod?id=9317","lat":50.185,"lon":17.0524},
{"date":"25.10.2025","name":"Oblastní žebříček","place":"Jahodov","link":"https://oris.orientacnisporty.cz/Zavod?id=8837","lat":50.1512,"lon":16.3325},
{"date":"25.10.2025","name":"Oblastní žebříček","place":"Sportpark Boskovice","link":"https://oris.orientacnisporty.cz/Zavod?id=9013","lat":49.4948,"lon":16.6808},
{"date":"25.10.2025","name":"GAPP Czech O-Tour 2025 - Krušné hory - E1","place":"Lesná, Krušné hory","link":"https://oris.orientacnisporty.cz/Zavod?id=8886","lat":50.5647,"lon":13.431},
{"date":"26.10.2025","name":"GAPP Czech O-Tour 2025 - Krušné hory - E2","place":"Lesná, Krušné hory","link":"https://oris.orientacnisporty.cz/Zavod?id=8887","lat":50.5647,"lon":13.431}
]
;
</script>
<!--DATA:END-->

  <script>
    // ---- Helpers ----
    const parseDMY = (s) => {
      if (!s) return null;
      const iso = /^\d{4}-\d{2}-\d{2}$/;
      if (iso.test(s)) return new Date(s + "T00:00:00");
      const m = s.match(/^(\d{1,2})[.\/-](\d{1,2})[.\/-](\d{2,4})$/);
      if (!m) return null;
      const d = parseInt(m[1], 10), mo = parseInt(m[2], 10) - 1, y = parseInt(m[3].length === 2 ? (2000 + parseInt(m[3], 10)) : m[3], 10);
      return new Date(y, mo, d);
    };
    const fmtDate = (d) => d ? d.toLocaleDateString(undefined, {year:'numeric', month:'2-digit', day:'2-digit'}) : "";
    const toNumberDate = (d) => d ? Math.floor(d.getTime() / 86400000) : NaN;
    function dotIcon(){ return L.divIcon({ className: 'race-pin', iconSize: [14,14] }); }

    // ---- Map init ----
    const map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
    map.setView([49.8, 15.5], 7);
    const layerGroup = L.layerGroup().addTo(map);

    let allRecords = [];

    function buildTooltipHTML(r){ return `<div class="tip"><div>${r.name}</div></div>`; }
    function buildPopupHTML(r){ return `<div><div>${r.name}</div><div>${r.place}</div><a href="${r.link}" target="_blank">Open in ORIS</a></div>`; }
    function makeMarker(r){ const m=L.marker([r.lat,r.lon],{icon:dotIcon()}); m.bindTooltip(buildTooltipHTML(r)); m.bindPopup(buildPopupHTML(r)); return m; }
    function refreshMap(a,b){ layerGroup.clearLayers(); let c=0; for(const r of allRecords){ if(r.dateNum>=a&&r.dateNum<=b){ r.marker.addTo(layerGroup); c++; } } document.getElementById('visibleCount').textContent=c; }
    function initSlider(minNum,maxNum){ const s=document.getElementById('slider'); noUiSlider.create(s,{start:[minNum,maxNum],connect:true,step:1,range:{min:minNum,max:maxNum}}); const st=document.getElementById('startLabel'); const en=document.getElementById('endLabel'); s.noUiSlider.on('update',(v)=>{ const[a,b]=v.map(x=>Math.round(+x)); st.textContent=fmtDate(new Date(a*86400000)); en.textContent=fmtDate(new Date(b*86400000)); refreshMap(a,b); }); const[a0,b0]=s.noUiSlider.get().map(v=>Math.round(+v)); refreshMap(a0,b0); }
    function fitToVisible(){ const b=L.latLngBounds(); layerGroup.eachLayer(l=>b.extend(l.getLatLng())); if(b.isValid()) map.fitBounds(b.pad(0.15)); }

    // ---- Bootstrap from baked data ----
    (function(){
      const status=document.getElementById('status');
      try {
        const rows=Array.isArray(window.ORIS_DATA)?window.ORIS_DATA:[];
        const recs=[];
        for(const row of rows){
          const date=parseDMY(row.date);
          const lat=parseFloat(row.lat), lon=parseFloat(row.lon);
          if(!date||isNaN(lat)||isNaN(lon)) continue;
          const rec={date,dateNum:toNumberDate(date),name:row.name||"",place:row.place||"",link:row.link||"",lat,lon};
          rec.marker=makeMarker(rec); recs.push(rec);
        }
        allRecords=recs.sort((a,b)=>a.date-b.date);
        document.getElementById('totalCount').textContent=allRecords.length;
        status.textContent='Ready';
        if(!allRecords.length){ status.textContent='No valid records.'; return; }
        const minNum=allRecords[0].dateNum, maxNum=allRecords[allRecords.length-1].dateNum;
        initSlider(minNum,maxNum); fitToVisible();
      } catch(e){ console.error(e); status.textContent='Error'; }
    })();
  </script>
</body>
</html>
