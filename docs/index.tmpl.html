<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Orienteering Races Map</title>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- noUiSlider -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.js"></script>

  <style>
    :root {
      --bg: #0b0d10; --panel: #14171c; --muted: #9aa4b2; --text: #e6edf3; --accent: #4aa3ff;
    }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, sans-serif; }
    .app { display: grid; grid-template-rows: auto 1fr; height: 100%; }
    .controls { display:flex; gap: 1rem; align-items:center; padding: .75rem 1rem; background: var(--panel); }
    .controls h1 { font-size: 1rem; margin: 0; font-weight: 600; }
    .slider-wrap { flex: 1 1 auto; }
    #slider { margin: .25rem 0; }
    .date-labels { display:flex; justify-content: space-between; font-size:.85rem; color: var(--muted); }
    .pill { background: rgba(74,163,255,.12); color: var(--accent); padding: .25rem .5rem; border-radius: 999px; font-size: .8rem; }
    .count { white-space: nowrap; }
    #map { height: calc(100vh - 64px); width: 100%; }

    /* Marker style */
    .race-pin { width: 14px; height: 14px; border-radius: 50%; background: #4aa3ff; border: 2px solid #e6edf3; }

    /* Popup styling */
    .popup-wrap { min-width: 260px; }
    .popup-title { font-weight: 600; margin: 0 0 .25rem 0; }
    .popup-sub { color: var(--muted); margin: 0 0 .5rem 0; font-size: .9rem; }
    .popup-table { width: 100%; border-collapse: collapse; font-size: .9rem; }
    .popup-table th, .popup-table td { text-align: left; padding: .2rem .25rem; vertical-align: top; }
    .popup-table th { color: var(--muted); font-weight: 500; white-space: nowrap; }
    .popup-link { display:inline-block; margin-top:.5rem; color: var(--accent); text-decoration: underline; }
  </style>
</head>
<body>
  <div class="app">
    <div class="controls">
      <h1>Orienteering Races</h1>
      <span class="pill" id="status">Loading…</span>
      <div class="slider-wrap">
        <div id="slider"></div>
        <div class="date-labels">
          <span id="startLabel">—</span><span id="endLabel">—</span>
        </div>
      </div>
      <div class="count"><span id="visibleCount">0</span>/<span id="totalCount">0</span></div>
    </div>
    <div id="map"></div>
  </div>

  <!--DATA:START-->
  <script>
    // Replaced by GitHub Actions workflow
    window.ORIS_DATA = __ORIS_DATA__;
  </script>
  <!--DATA:END-->

  <script>
    // ---- Helpers ----
    const parseDMY = (s) => {
      if (!s) return null;
      const iso = /^\d{4}-\d{2}-\d{2}$/;
      if (iso.test(s)) return new Date(s + "T00:00:00");
      const m = s.match(/^(\d{1,2})[.\/-](\d{1,2})[.\/-](\d{2,4})$/);
      if (!m) return null;
      const d = parseInt(m[1], 10), mo = parseInt(m[2], 10) - 1, y = parseInt(m[3].length === 2 ? (2000 + parseInt(m[3], 10)) : m[3], 10);
      return new Date(y, mo, d);
    };
    const fmtDate = (d) => d ? d.toLocaleDateString(undefined, {year:'numeric', month:'2-digit', day:'2-digit'}) : "";
    const toNumberDate = (d) => d ? Math.floor(d.getTime() / 86400000) : NaN;
    function dotIcon(){ return L.divIcon({ className: 'race-pin', iconSize: [14,14] }); }

    // ---- Map init ----
    const map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
    map.setView([49.8, 15.5], 7);
    const layerGroup = L.layerGroup().addTo(map);

    let allRecords = [];

    // Build popup from the row's table (no tooltip used)
    function buildPopupHTML(r){
      const safe = (x) => String(x ?? '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const rows = (r.rawTable || []).map(({nazev, hodnota}) => {
        return `<tr><th>${safe((nazev||'').replace(/:$/,''))}</th><td>${safe(hodnota||'')}</td></tr>`;
      }).join('');
      const title = safe(r.name || '(bez názvu)');
      const place = safe(r.place || '');
      const date = r.date ? fmtDate(r.date) : '';
      const link = r.link ? `<a class="popup-link" href="${r.link}" target="_blank" rel="noopener">Otevřít v ORIS</a>` : '';
      return `
        <div class="popup-wrap">
          <div class="popup-title">${title}</div>
          <div class="popup-sub">${[place, date].filter(Boolean).join(" • ")}</div>
          <table class="popup-table">${rows}</table>
          ${link}
        </div>
      `;
    }

    // Marker creation (popup only, per request)
    function makeMarker(r){
      const m = L.marker([r.lat, r.lon], { icon: dotIcon() });
      m.bindPopup(buildPopupHTML(r));
      return m;
    }

    // ---- Fixed "next 7 days" window (computed once) ----
    const today = new Date();
    today.setHours(0,0,0,0);
    const next7StartNum = toNumberDate(today);
    const next7EndNum   = next7StartNum + 6; // inclusive

    // Only show markers that are BOTH within the slider range AND within the next 7 days
    function refreshMap(sliderA, sliderB){
      // Effective intersection
      const a = Math.max(sliderA, next7StartNum);
      const b = Math.min(sliderB, next7EndNum);

      layerGroup.clearLayers();
      let c = 0;

      if (a <= b) {
        for (const r of allRecords){
          if (Number.isFinite(r.dateNum) && r.dateNum >= a && r.dateNum <= b){
            r.marker.addTo(layerGroup);
            c++;
          }
        }
      }
      document.getElementById('visibleCount').textContent = c;
    }

    function initSlider(minNum,maxNum){
      const s = document.getElementById('slider');
      noUiSlider.create(s,{start:[minNum,maxNum],connect:true,step:1,range:{min:minNum,max:maxNum}});
      const st=document.getElementById('startLabel');
      const en=document.getElementById('endLabel');
      s.noUiSlider.on('update',(v)=>{
        const [a,b]=v.map(x=>Math.round(+x));
        st.textContent=fmtDate(new Date(a*86400000));
        en.textContent=fmtDate(new Date(b*86400000));
        refreshMap(a,b);
      });
      const [a0,b0]=s.noUiSlider.get().map(v=>Math.round(+v));
      refreshMap(a0,b0);
    }

    function fitToVisible(){
      const b=L.latLngBounds();
      layerGroup.eachLayer(l=>b.extend(l.getLatLng()));
      if(b.isValid()) map.fitBounds(b.pad(0.15));
    }

    // ---- Transform ORIS_DATA -> records used by the map ----
    (function(){
      const status=document.getElementById('status');
      try {
        const rows = Array.isArray(window.ORIS_DATA) ? window.ORIS_DATA : [];
        const recs = [];

        const getField = (tbl, label) => {
          if (!Array.isArray(tbl)) return '';
          const found = tbl.find(x => (x?.nazev || '').replace(/:$/,'') === label.replace(/:$/,''));
          return found ? (found.hodnota || '') : '';
        };

        for (const row of rows){
          // --- Location (prefer top-level gps, fallback to "Souřadnice") ---
          // UPDATED: take coords directly when present
          let lat = NaN, lon = NaN;
          const gpsRaw = row.gps || getField(row.tbl, 'Souřadnice');
          if (gpsRaw){
            const m = String(gpsRaw).match(/(-?\d+(?:\.\d+)?)[,\s]+(-?\d+(?:\.\d+)?)/);
            if (m){ lat = parseFloat(m[1]); lon = parseFloat(m[2]); }
          }

          // --- Core fields ---
          const name   = getField(row.tbl, 'Název');
          const place  = getField(row.tbl, 'Místo konání');

          // UPDATED: prefer top-level date, fallback to table "Datum"
          const date   = parseDMY(row.date) || parseDMY(getField(row.tbl, 'Datum'));

          // UPDATED: prefer top-level URL; fallback to ORIS ID only if needed
          const orisId = getField(row.tbl, 'ORIS ID');
          const link   = row.url || (orisId ? `https://oris.orientacnisporty.cz/Zavod?id=${encodeURIComponent(orisId)}` : '');

          // Skip if no valid coordinates
          if (isNaN(lat) || isNaN(lon)) continue;

          const rec = {
            date,
            dateNum: toNumberDate(date),
            name, place, link, lat, lon,
            rawTable: row.tbl
          };
          rec.marker = makeMarker(rec);
          recs.push(rec);
        }

        // Sort by date (unknown dates last)
        recs.sort((a,b)=>{
          if (!a.date && !b.date) return 0;
          if (!a.date) return 1;
          if (!b.date) return -1;
          return a.date - b.date;
        });

        allRecords = recs;
        document.getElementById('totalCount').textContent = allRecords.length;

        if(!allRecords.length){
          status.textContent='No valid records.';
          return;
        }

        // Slider bounds: full data range
        const dated = allRecords.filter(r=>Number.isFinite(r.dateNum));
        const todayNum = next7StartNum; // already normalized to midnight
        const minNum = dated.length ? Math.min(...dated.map(r=>r.dateNum)) : todayNum;
        const maxNum = dated.length ? Math.max(...dated.map(r=>r.dateNum)) : todayNum;

        // Status: fixed next-7-days window (independent of slider)
        const next7Label = `${fmtDate(new Date(next7StartNum*86400000))} – ${fmtDate(new Date(next7EndNum*86400000))}`;
        status.textContent = `Filtering to: ${next7Label}`;

        initSlider(minNum, maxNum);
        fitToVisible();
      } catch(e){
        console.error(e);
        status.textContent='Error';
      }
    })();
  </script>
</body>
</html>
