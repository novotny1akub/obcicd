<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Orienteering Races Map</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root { --bg:#0b0d10; --panel:#14171c; --muted:#9aa4b2; --text:#e6edf3; --accent:#4aa3ff; }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui, sans-serif; }
    .app { display:grid; grid-template-rows:auto 1fr; height:100%; }
    .controls { display:flex; gap:1rem; align-items:center; padding:.75rem 1rem; background:var(--panel); }
    .controls h1 { font-size:1rem; margin:0; font-weight:600; }
    .pill { background:rgba(74,163,255,.12); color:var(--accent); padding:.25rem .5rem; border-radius:999px; font-size:.8rem; white-space:nowrap; }
    .count { white-space:nowrap; }
    #map { height:calc(100vh - 64px); width:100%; }

    /* Slider */
    .slider-wrap { flex:1 1 auto; display:grid; gap:.35rem; align-items:center; }
    .slider-row { display:grid; grid-template-columns:1fr 1fr auto; gap:.75rem; align-items:center; }
    .range { appearance:none; width:100%; height:6px; border-radius:4px; background:#243041; outline:none; }
    .range::-webkit-slider-thumb { appearance:none; width:16px; height:16px; border-radius:50%; background:#e6edf3; border:2px solid #4aa3ff; cursor:pointer; }
    .range::-moz-range-thumb { width:16px; height:16px; border-radius:50%; background:#e6edf3; border:2px solid #4aa3ff; cursor:pointer; }
    .date-labels { display:flex; justify-content:space-between; font-size:.85rem; color:var(--muted); }
    .btn { background:#1b2230; color:#e6edf3; border:1px solid #2e3a4e; padding:.45rem .7rem; border-radius:.5rem; cursor:pointer; }
    .btn:hover { background:#222b3d; }
    .tip { font-size:.8rem; color:var(--muted); }
    /* Marker */
    .race-pin { width:14px; height:14px; border-radius:50%; background:#4aa3ff; border:2px solid #e6edf3; }
    /* Popup */
    .popup-wrap { min-width:260px; }
    .popup-title { font-weight:600; margin:0 0 .25rem 0; }
    .popup-sub { color:var(--muted); margin:0 0 .5rem 0; font-size:.9rem; }
    .popup-table { width:100%; border-collapse:collapse; font-size:.9rem; }
    .popup-table th, .popup-table td { text-align:left; padding:.2rem .25rem; vertical-align:top; }
    .popup-table th { color:var(--muted); font-weight:500; white-space:nowrap; }
    .popup-link { display:inline-block; margin-top:.5rem; color:var(--accent); text-decoration:underline; }
  </style>
</head>
<body>
  <div class="app">
    <div class="controls">
      <h1>Orienteering Races</h1>
      <span class="pill" id="status">Loading…</span>

      <div class="slider-wrap">
        <div class="slider-row">
          <input id="rangeA" class="range" type="range" />
          <input id="rangeB" class="range" type="range" />
          <button id="snapNext7" class="btn" title="Limit slider to the next 7 days">Snap to next 7</button>
        </div>
        <div class="date-labels">
          <span><strong>From:</strong> <span id="startLabel">—</span></span>
          <span class="tip">Showing intersection with <span id="fixedWindow">—</span></span>
          <span><strong>To:</strong> <span id="endLabel">—</span></span>
        </div>
      </div>

      <div class="count"><span id="visibleCount">0</span>/<span id="totalCount">0</span></div>
    </div>
    <div id="map"></div>
  </div>

  <!--DATA:START-->
  <script>
    // Replaced by GitHub Actions workflow
    window.ORIS_DATA = __ORIS_DATA__;
  </script>
  <!--DATA:END-->

  <script>
    // ---------- Helpers ----------
    const MS_PER_DAY = 86400000;

    // Parse dates like "04.10.2025" or "2025-10-04", returning a Date at local midnight
    const parseDMY = (s) => {
      if (!s) return null;
      const iso = /^\d{4}-\d{2}-\d{2}$/;
      if (iso.test(s)) return new Date(s + "T00:00:00"); // local midnight
      const m = s.match(/^(\d{1,2})[.\/-](\d{1,2})[.\/-](\d{2,4})$/);
      if (!m) return null;
      const d = +m[1], mo = +m[2] - 1, y = m[3].length === 2 ? 2000 + +m[3] : +m[3];
      return new Date(y, mo, d); // local midnight
    };

    const fmtDate = (d) => d ? d.toLocaleDateString(undefined, {year:'numeric', month:'2-digit', day:'2-digit'}) : "";

    // Convert Date -> integer "day index" using local-midnight milliseconds / MS_PER_DAY
    const dayIndex = (d) => d ? Math.floor(new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime() / MS_PER_DAY) : NaN;
    const dayIndexToDate = (n) => new Date(n * MS_PER_DAY); // reconstructs local date from index

    function dotIcon(){ return L.divIcon({ className: 'race-pin', iconSize: [14,14] }); }

    // ---------- Map ----------
    const map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
    map.setView([49.8, 15.5], 7);
    const layerGroup = L.layerGroup().addTo(map);

    let allRecords = [];

    function buildPopupHTML(r){
      const safe = (x) => String(x ?? '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const rows = (r.rawTable || []).map(({nazev, hodnota}) =>
        `<tr><th>${safe((nazev||'').replace(/:$/,''))}</th><td>${safe(hodnota||'')}</td></tr>`
      ).join('');
      const title = safe(r.name || '(bez názvu)');
      const place = safe(r.place || '');
      const date = r.date ? fmtDate(r.date) : '';
      const link = r.link ? `<a class="popup-link" href="${r.link}" target="_blank" rel="noopener">Otevřít v ORIS</a>` : '';
      return `
        <div class="popup-wrap">
          <div class="popup-title">${title}</div>
          <div class="popup-sub">${[place, date].filter(Boolean).join(" • ")}</div>
          <table class="popup-table">${rows}</table>
          ${link}
        </div>`;
    }

    function makeMarker(r){
      const m = L.marker([r.lat, r.lon], { icon: dotIcon() });
      m.bindPopup(buildPopupHTML(r));
      return m;
    }

    // ---------- Fixed "next 7 days" window (LOCAL) ----------
    const today = new Date();
    const next7StartIdx = dayIndex(today);
    const next7EndIdx   = next7StartIdx + 6; // inclusive

    // ---------- Slider (custom dual handle) ----------
    const rangeA = document.getElementById('rangeA'); // lower
    const rangeB = document.getElementById('rangeB'); // upper
    const startLabel = document.getElementById('startLabel');
    const endLabel = document.getElementById('endLabel');
    const fixedWindow = document.getElementById('fixedWindow');

    function setSliderBounds(minIdx, maxIdx){
      for (const el of [rangeA, rangeB]) {
        el.min = String(minIdx);
        el.max = String(maxIdx);
        el.step = "1"; // one day per tick
      }
      rangeA.value = String(minIdx);
      rangeB.value = String(maxIdx);
      updateSliderLabels();
    }

    function updateSliderLabels(){
      const a = Math.min(+rangeA.value, +rangeB.value);
      const b = Math.max(+rangeA.value, +rangeB.value);
      startLabel.textContent = fmtDate(dayIndexToDate(a));
      endLabel.textContent   = fmtDate(dayIndexToDate(b));
    }

    function getSliderRange(){
      const a = Math.min(+rangeA.value, +rangeB.value);
      const b = Math.max(+rangeA.value, +rangeB.value);
      return [a, b];
    }

    function snapSliderToNext7(){
      // Keep slider bounds the same but set handles to the next-7 range
      rangeA.value = String(next7StartIdx);
      rangeB.value = String(next7EndIdx);
      updateSliderLabels();
      const [a, b] = getSliderRange();
      refreshMap(a, b);
    }

    document.getElementById('snapNext7').addEventListener('click', snapSliderToNext7);

    for (const el of [rangeA, rangeB]) {
      el.addEventListener('input', () => {
        // keep labels snappy and map live
        updateSliderLabels();
        const [a, b] = getSliderRange();
        refreshMap(a, b);
      });
      el.addEventListener('change', () => {
        // ensure whole-day integers (already integers, but defensive)
        el.value = String(Math.round(+el.value));
        updateSliderLabels();
        const [a, b] = getSliderRange();
        refreshMap(a, b);
      });
    }

    // ---------- Core filtering ----------
    function refreshMap(sliderAIdx, sliderBIdx){
      // Intersection with fixed next-7 window
      const a = Math.max(sliderAIdx, next7StartIdx);
      const b = Math.min(sliderBIdx, next7EndIdx);

      layerGroup.clearLayers();
      let shown = 0;

      if (a <= b) {
        for (const r of allRecords){
          if (Number.isFinite(r.dayIdx) && r.dayIdx >= a && r.dayIdx <= b){
            r.marker.addTo(layerGroup);
            shown++;
          }
        }
      }

      document.getElementById('visibleCount').textContent = shown;
      fitToVisible();
    }

    function fitToVisible(){
      const bounds = L.latLngBounds();
      layerGroup.eachLayer(l => bounds.extend(l.getLatLng()));
      if (bounds.isValid()) map.fitBounds(bounds.pad(0.15));
    }

    // ---------- Data ingest ----------
    (function init(){
      const status = document.getElementById('status');
      try {
        const rows = Array.isArray(window.ORIS_DATA) ? window.ORIS_DATA : [];
        const recs = [];

        const getField = (tbl, label) => {
          if (!Array.isArray(tbl)) return '';
          const found = tbl.find(x => (x?.nazev || '').replace(/:$/,'') === label.replace(/:$/,''));
          return found ? (found.hodnota || '') : '';
        };

        for (const row of rows){
          // Coordinates
          let lat = NaN, lon = NaN;
          const gpsRaw = row.gps || getField(row.tbl, 'Souřadnice');
          if (gpsRaw){
            const m = String(gpsRaw).match(/(-?\d+(?:\.\d+)?)[,\s]+(-?\d+(?:\.\d+)?)/);
            if (m){ lat = parseFloat(m[1]); lon = parseFloat(m[2]); }
          }
          if (isNaN(lat) || isNaN(lon)) continue;

          // Fields
          const name   = getField(row.tbl, 'Název');
          const place  = getField(row.tbl, 'Místo konání');
          const date   = parseDMY(getField(row.tbl, 'Datum'));
          const idRaw  = getField(row.tbl, 'ORIS ID');
          const link   = idRaw ? `https://oris.orientacnisporty.cz/Zavod?id=${encodeURIComponent(idRaw)}` : '';

          const rec = {
            date,
            dayIdx: dayIndex(date),
            name, place, link, lat, lon,
            rawTable: row.tbl,
          };
          rec.marker = makeMarker(rec);
          recs.push(rec);
        }

        // Sort by date (unknown last)
        recs.sort((a,b)=>{
          if (!a.date && !b.date) return 0;
          if (!a.date) return 1;
          if (!b.date) return -1;
          return a.date - b.date;
        });

        allRecords = recs;
        document.getElementById('totalCount').textContent = allRecords.length;

        // Status label & fixed window
        const fixedLabel = `${fmtDate(dayIndexToDate(next7StartIdx))} – ${fmtDate(dayIndexToDate(next7EndIdx))}`;
        fixedWindow.textContent = fixedLabel;
        status.textContent = `Filtering to: ${fixedLabel}`;

        if(!allRecords.length){
          return;
        }

        // Slider bounds from data (day indexes)
        const dated = allRecords.filter(r => Number.isFinite(r.dayIdx));
        const minIdx = dated.length ? Math.min(...dated.map(r => r.dayIdx)) : next7StartIdx;
        const maxIdx = dated.length ? Math.max(...dated.map(r => r.dayIdx)) : next7StartIdx;

        setSliderBounds(minIdx, maxIdx);

        // Initial paint: keep slider full-span but intersection limits to next 7
        const [a0, b0] = getSliderRange();
        refreshMap(a0, b0);
      } catch (e) {
        console.error(e);
        status.textContent = 'Error';
      }
    })();
  </script>
</body>
</html>
