<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Orienteering Races Map</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- noUiSlider -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.js"></script>

  <style>
    :root { --bg:#0b0d10; --panel:#14171c; --muted:#9aa4b2; --text:#e6edf3; --accent:#4aa3ff; }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui, sans-serif; }
    .app { display:grid; grid-template-rows:auto 1fr; height:100%; }
    .controls { display:flex; gap:1rem; align-items:center; padding:.75rem 1rem; background:var(--panel); }
    .controls h1 { font-size:1rem; margin:0; font-weight:600; }
    .slider-wrap { flex:1 1 auto; min-width:260px; }
    #slider { margin:.35rem 0 .25rem; }
    .date-labels { display:flex; justify-content:space-between; font-size:.85rem; color:var(--muted); }
    .pill { background:rgba(74,163,255,.12); color:var(--accent); padding:.25rem .5rem; border-radius:999px; font-size:.8rem; white-space:nowrap; }
    .count { white-space:nowrap; }
    #map { height:calc(100vh - 64px); width:100%; }

    /* Marker style */
    .race-pin { width:14px; height:14px; border-radius:50%; background:#4aa3ff; border:2px solid #e6edf3; }

    /* Popup styling */
    .popup-wrap { min-width:260px; }
    .popup-title { font-weight:600; margin:0 0 .25rem 0; }
    .popup-sub { color:var(--muted); margin:0 0 .5rem 0; font-size:.9rem; }
    .popup-table { width:100%; border-collapse:collapse; font-size:.9rem; }
    .popup-table th, .popup-table td { text-align:left; padding:.2rem .25rem; vertical-align:top; }
    .popup-table th { color:var(--muted); font-weight:500; white-space:nowrap; }
    .popup-link { display:inline-block; margin-top:.5rem; color:var(--accent); text-decoration:underline; }
  </style>
</head>
<body>
  <div class="app">
    <div class="controls">
      <h1>Orienteering Races</h1>
      <span class="pill" id="status">Loading…</span>
      <div class="slider-wrap">
        <div id="slider"></div>
        <div class="date-labels">
          <span><strong>From</strong> <span id="startLabel">—</span></span>
          <span><strong>To</strong> <span id="endLabel">—</span></span>
        </div>
      </div>
      <div class="count"><span id="visibleCount">0</span>/<span id="totalCount">0</span></div>
    </div>
    <div id="map"></div>
  </div>

  <!--DATA:START-->
  <script>
    // Replaced by your pipeline
    window.ORIS_DATA = __ORIS_DATA__;
  </script>
  <!--DATA:END-->

  <script>
    // ---------- Helpers ----------
    const MS_PER_DAY = 86400000;
    const HIDE_FIELDS = new Set(['ORIS ID', 'Souřadnice']);

    // Parse "04.10.2025" or "2025-10-04" -> Date (local midnight)
    function parseDMY(s){
      if (!s) return null;
      const iso = /^\d{4}-\d{2}-\d{2}$/;
      if (iso.test(s)) return new Date(s + "T00:00:00");
      const m = s.match(/^(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{2,4})$/);
      if (!m) return null;
      const d = +m[1], mo = +m[2] - 1, y = m[3].length === 2 ? 2000 + +m[3] : +m[3];
      return new Date(y, mo, d);
    }
    const fmtDate = (d) => d ? d.toLocaleDateString(undefined, {year:'numeric', month:'2-digit', day:'2-digit'}) : "";
    const toDayNumUTC = (d) => d ? Math.floor(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()) / MS_PER_DAY) : NaN;
    const dayNumToLocalDate = (n) => {
      const du = new Date(n * MS_PER_DAY);
      return new Date(du.getUTCFullYear(), du.getUTCMonth(), du.getUTCDate());
    };

    function dotIcon(){
      // Include Leaflet’s base div-icon class for robustness
      return L.divIcon({ className:'leaflet-div-icon race-pin', iconSize:[14,14] });
    }

    // ---------- Map ----------
    const map = L.map('map', { worldCopyJump: true });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    map.setView([20, 0], 2);

    const layerGroup = L.layerGroup().addTo(map);

    // ---------- Data ingest ----------
    let allRecords = [];
    let didAutoFitOnce = false; // only auto-fit on the very first render

    function getField(tbl, label){
      if (!Array.isArray(tbl)) return '';
      const found = tbl.find(x => (x?.nazev || '').replace(/:$/,'') === label.replace(/:$/,''));
      return found ? (found.hodnota || '') : '';
    }

    function buildPopupHTML(r){
      const safe = (x) => String(x ?? '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const rows = (r.rawTable || [])
        .filter(({ nazev }) => !HIDE_FIELDS.has(String(nazev || '').replace(/:$/,'')))
        .map(({ nazev, hodnota }) =>
          `<tr><th>${safe((nazev||'').replace(/:$/,''))}</th><td>${safe(hodnota||'')}</td></tr>`
        ).join('');
      const title = safe(r.name || '(bez názvu)');
      const place = safe(r.place || '');
      const date = r.date ? fmtDate(r.date) : '';
      const link = r.link ? `<a class="popup-link" href="${r.link}" target="_blank" rel="noopener">Otevřít v ORIS</a>` : '';
      return `
        <div class="popup-wrap">
          <div class="popup-title">${title}</div>
          <div class="popup-sub">${[place, date].filter(Boolean).join(' • ')}</div>
          <table class="popup-table">${rows}</table>
          ${link}
        </div>`;
    }

    function makeMarker(r){
      const m = L.marker([r.lat, r.lon], { icon: dotIcon() });
      m.bindPopup(buildPopupHTML(r), { direction: "center" });
      return m;
    }

    // Build records from ORIS_DATA
    (function(){
      const status = document.getElementById('status');
      try {
        const rows = Array.isArray(window.ORIS_DATA) ? window.ORIS_DATA : [];
        const recs = [];

        for (const row of rows){
          // Coordinates from 'gps' or from 'Souřadnice'
          let lat = NaN, lon = NaN;
          const gpsRaw = row.gps || getField(row.tbl, 'Souřadnice');
          if (gpsRaw){
            const m = String(gpsRaw).match(/(-?\d+(?:\.\d+)?)[,\s]+(-?\d+(?:\.\d+)?)/);
            if (m){ lat = parseFloat(m[1]); lon = parseFloat(m[2]); }
          }
          if (isNaN(lat) || isNaN(lon)) continue;

          const name   = getField(row.tbl, 'Název');
          const place  = getField(row.tbl, 'Místo konání');

          // Fallback to top-level row.date if the table 'Datum' is missing
          const dateRaw = getField(row.tbl, 'Datum') || row.date;
          const date    = parseDMY(dateRaw);

          const orisId = getField(row.tbl, 'ORIS ID');
          const link   = orisId ? `https://oris.orientacnisporty.cz/Zavod?id=${encodeURIComponent(orisId)}` : (row.url || '');

          const record = {
            name, place, date, link,
            dateNum: toDayNumUTC(date),
            lat, lon,
            rawTable: row.tbl
          };
          record.marker = makeMarker(record);
          recs.push(record);
        }

        // Sort by date (unknown last)
        recs.sort((a,b)=>{
          if (!a.date && !b.date) return 0;
          if (!a.date) return 1;
          if (!b.date) return -1;
          return a.date - b.date;
        });

        allRecords = recs;
        document.getElementById('totalCount').textContent = allRecords.length;

        if (!allRecords.length){
          status.textContent = 'No valid records.';
          return;
        }

        initSliderAndRender();
      } catch (e){
        console.error(e);
        status.textContent = 'Error';
      }
    })();

    // ---------- Slider + filtering (ALL races) ----------
    function initSliderAndRender(){
      const dated = allRecords.filter(r => Number.isFinite(r.dateNum));
      const minNum = dated.length ? Math.min(...dated.map(r => r.dateNum)) : toDayNumUTC(new Date());
      const maxNum = dated.length ? Math.max(...dated.map(r => r.dateNum)) : minNum;

      const slider = document.getElementById('slider');
      noUiSlider.create(slider, {
        start: [minNum, maxNum],
        connect: true,
        step: 1,
        range: { min: minNum, max: maxNum },
        behaviour: 'tap-drag'
      });

      const st = document.getElementById('startLabel');
      const en = document.getElementById('endLabel');
      const status = document.getElementById('status');

      const update = () => {
        const [a0, b0] = slider.noUiSlider.get().map(v => Math.round(+v));
        const a = Math.min(a0, b0), b = Math.max(a0, b0);

        st.textContent = fmtDate(dayNumToLocalDate(a));
        en.textContent = fmtDate(dayNumToLocalDate(b));

        layerGroup.clearLayers();
        let shown = 0;
        const bounds = L.latLngBounds();

        for (const r of allRecords){
          // Show undated items, and date-filter the rest
          if (!Number.isFinite(r.dateNum) || (r.dateNum >= a && r.dateNum <= b)){
            r.marker.addTo(layerGroup);
            bounds.extend([r.lat, r.lon]);
            shown++;
          }
        }

        document.getElementById('visibleCount').textContent = shown;

        // Auto-fit only once (on very first render), then never again
        if (!didAutoFitOnce && shown > 0 && bounds.isValid()){
          map.fitBounds(bounds.pad(0.15));
          didAutoFitOnce = true;
        }

        // Keep status pill blank (removes "Showing: ..." text)
        status.textContent = '';
      };

      slider.noUiSlider.on('update', update);
      update(); // initial paint -> will auto-fit once if there are points
    }
  </script>
</body>
</html>
